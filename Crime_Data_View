USE DATABASE MY_CRIME_STAT;
USE SCHEMA CRIME_SCHEMA;

/* FBI Crime Data Views */

/* 1. FBI Total Offense Cases By Each Category By Year*/
CREATE OR REPLACE VIEW FBI_US_Total_Category_By_Year
AS 
WITH YearlyOffense AS (
    SELECT ca.OFFENSE_CATEGORY, YEAR(ct.DATE) AS YEAR, SUM(ct.VALUE) AS OFFENSE_COUNT
    FROM CRIME_STATISTICS.CYBERSYN.FBI_CRIME_TIMESERIES ct
    JOIN CRIME_STATISTICS.CYBERSYN.FBI_CRIME_ATTRIBUTES ca
    ON ct.VARIABLE = ca.VARIABLE
    WHERE ct.GEO_ID != 'country/USA'
    GROUP BY ca.OFFENSE_CATEGORY, YEAR(ct.DATE)
)
SELECT y.OFFENSE_CATEGORY, y.YEAR, y.OFFENSE_COUNT, 
    pop.TOTAL_POPULATION,
    TO_CHAR(ROUND(y.OFFENSE_COUNT / total_yearly.TOTAL * 100.0, 2)) || '%' AS OFFENSE_CATEGORY_PROPORTION,
    ROUND(y.OFFENSE_COUNT / pop.TOTAL_POPULATION * 100000.0, 1) AS CATEGORY_CRIME_RATE
FROM yearlyoffense y
JOIN (SELECT YEAR(DATE) AS YEAR, SUM(VALUE) AS TOTAL
    FROM CRIME_STATISTICS.CYBERSYN.FBI_CRIME_TIMESERIES
    WHERE GEO_ID != 'country/USA'
    GROUP BY YEAR(DATE)) AS total_yearly
ON y.YEAR = total_yearly.YEAR
JOIN MY_CRIME_STAT.CRIME_SCHEMA.US_POPULATION POP
ON y.YEAR = pop.YEAR
ORDER BY y.OFFENSE_CATEGORY, y.YEAR;

CREATE OR REPLACE VIEW FBI_US_Total_Category_By_Year AS 
WITH YearlyOffense AS (
    SELECT 
        ca.OFFENSE_CATEGORY, 
        YEAR(ct.DATE) AS YEAR, 
        SUM(ct.VALUE) AS OFFENSE_COUNT
    FROM 
        CRIME_STATISTICS.CYBERSYN.FBI_CRIME_TIMESERIES ct
    JOIN 
        CRIME_STATISTICS.CYBERSYN.FBI_CRIME_ATTRIBUTES ca
    ON 
        ct.VARIABLE = ca.VARIABLE
    WHERE 
        ct.GEO_ID != 'country/USA'
    GROUP BY 
        ca.OFFENSE_CATEGORY, 
        YEAR(ct.DATE)
),
TotalYearly AS (
    SELECT 
        YEAR(DATE) AS YEAR, 
        SUM(VALUE) AS TOTAL
    FROM 
        CRIME_STATISTICS.CYBERSYN.FBI_CRIME_TIMESERIES
    WHERE 
        GEO_ID != 'country/USA'
    GROUP BY 
        YEAR(DATE)
)
SELECT 
    y.OFFENSE_CATEGORY, 
    y.YEAR, 
    y.OFFENSE_COUNT, 
    pop.TOTAL_POPULATION,
    CONCAT(
        TO_CHAR(ROUND(y.OFFENSE_COUNT / total_yearly.TOTAL * 100.0, 2)), '%'
    ) AS OFFENSE_CATEGORY_PROPORTION,
    ROUND(y.OFFENSE_COUNT / pop.TOTAL_POPULATION * 100000.0, 1) AS CATEGORY_CRIME_RATE
FROM 
    YearlyOffense y
JOIN 
    TotalYearly total_yearly ON y.YEAR = total_yearly.YEAR
JOIN 
    MY_CRIME_STAT.CRIME_SCHEMA.US_POPULATION pop ON y.YEAR = pop.YEAR
ORDER BY 
    y.OFFENSE_CATEGORY, 
    y.YEAR;


/* 2. FBI US Total Crime Rate By Year */
CREATE OR REPLACE VIEW FBI_US_Total_Crime_Rate_By_Year
AS
SELECT YEAR, SUM(OFFENSE_COUNT) AS TOTAL_OFFENSE,TOTAL_POPULATION,
    ROUND(SUM(OFFENSE_COUNT) / TOTAL_POPULATION * 100000.0, 1) AS TOTAL_CRIME_RATE
FROM MY_CRIME_STAT.CRIME_SCHEMA.FBI_US_TOTAL_CATEGORY_BY_YEAR
GROUP BY YEAR, TOTAL_POPULATION
ORDER BY YEAR;

/* 3. FBI Offense Cases Counts By Each Region By Year */
CREATE OR REPLACE VIEW FBI_State_Category_Count_By_Year
AS 
WITH TEMP AS (
    SELECT geo.GEO_NAME AS STATE, ca.OFFENSE_CATEGORY, YEAR(ct.DATE) AS YEAR, VALUE AS OFFENSE_COUNT, sp.POPULATION, 
    ROUND(VALUE / POPULATION * 100000.0, 1) AS CATEGORY_CRIME_RATE
    FROM CRIME_STATISTICS.CYBERSYN.FBI_CRIME_TIMESERIES ct
    JOIN CRIME_STATISTICS.CYBERSYN.FBI_CRIME_ATTRIBUTES ca
    ON ct.VARIABLE = ca.VARIABLE
    JOIN CRIME_STATISTICS.CYBERSYN.GEOGRAPHY_INDEX geo
    ON ct.GEO_ID = geo.GEO_ID
    JOIN MY_CRIME_STAT.CRIME_SCHEMA.STATE_POPULATION sp
    ON geo.GEO_NAME = sp.STATE AND YEAR(ct.DATE) = sp.YEAR
    WHERE ct.GEO_ID != 'country/USA'
    ORDER BY geo.GEO_NAME, YEAR(ct.DATE)
)
SELECT TEMP.STATE, TEMP.YEAR, TEMP.OFFENSE_CATEGORY, TEMP.OFFENSE_COUNT, TEMP.POPULATION,
    TO_CHAR(ROUND(TEMP.OFFENSE_COUNT / y.YEARLY_TOTAL_OFFENSE_COUNT * 100.0, 2)) || '%' AS OFFENSE_CATEGORY_PROPORTION,
    TEMP.CATEGORY_CRIME_RATE
FROM TEMP
JOIN (SELECT geo.GEO_NAME AS STATE, YEAR(ct.DATE) AS YEAR, SUM(VALUE) AS YEARLY_TOTAL_OFFENSE_COUNT
    FROM CRIME_STATISTICS.CYBERSYN.FBI_CRIME_TIMESERIES ct
    JOIN CRIME_STATISTICS.CYBERSYN.GEOGRAPHY_INDEX geo
    ON ct.GEO_ID = geo.GEO_ID
    WHERE ct.GEO_ID != 'country/USA'
    GROUP BY geo.GEO_NAME, YEAR(ct.DATE)) y
ON TEMP.STATE = y.STATE AND TEMP.YEAR = y.YEAR
ORDER BY TEMP.STATE, TEMP.YEAR, TEMP.OFFENSE_CATEGORY;

/* 4. FBI State Total Crime Rate By Year */
CREATE OR REPLACE VIEW FBI_State_Total_Crime_Rate_By_Year
AS
SELECT STATE, YEAR, SUM(OFFENSE_COUNT) AS TOTAL_OFFENSE, POPULATION,
    ROUND(SUM(OFFENSE_COUNT) / POPULATION * 100000.0, 1) AS TOTAL_CRIME_RATE
FROM MY_CRIME_STAT.CRIME_SCHEMA.FBI_STATE_CATEGORY_COUNT_BY_YEAR
GROUP BY STATE, YEAR, POPULATION
ORDER BY STATE, YEAR;

CREATE OR REPLACE VIEW FBI_State_All
AS
SELECT * FROM MY_CRIME_STAT.CRIME_SCHEMA.FBI_STATE_CATEGORY_COUNT_BY_YEAR

/* URBAN Crime Data Views */

/* 1. Urban level Total Offense Cases Count By Each City By Year and Month */
CREATE VIEW IF NOT EXISTS URBAN_City_Total_Category_Count_By_Year_And_Month
AS
SELECT uct.CITY, YEAR(uct.DATE) AS YEAR, MONTH(uct.DATE) AS MONTH, uca.OFFENSE_CATEGORY, SUM(VALUE) AS OFFENSE_COUNT
FROM CRIME_STATISTICS.CYBERSYN.URBAN_CRIME_TIMESERIES uct
JOIN CRIME_STATISTICS.CYBERSYN.URBAN_CRIME_ATTRIBUTES uca
ON uct.VARIABLE = uca.VARIABLE
WHERE uca.OFFENSE_CATEGORY != 'All categories'
GROUP BY uct.CITY, YEAR(uct.DATE), MONTH(uct.DATE), uca.OFFENSE_CATEGORY
ORDER BY uct.CITY, YEAR(uct.DATE), MONTH(uct.DATE), uca.OFFENSE_CATEGORY;

/* 2. Urban Level Offense Cases Counts By Each City Region By Year and Month */
CREATE VIEW IF NOT EXISTS URBAN_City_Region_Category_Count_By_Year_And_Month
AS
SELECT uct.CITY, YEAR(uct.DATE) AS YEAR, MONTH(uct.DATE) AS MONTH, SUBSTRING(uct.GEO_ID,5,9) AS ZIP_CODE, uca.OFFENSE_CATEGORY, SUM(VALUE) AS OFFENSE_COUNT
FROM CRIME_STATISTICS.CYBERSYN.URBAN_CRIME_TIMESERIES uct
JOIN CRIME_STATISTICS.CYBERSYN.URBAN_CRIME_ATTRIBUTES uca
ON uct.VARIABLE = uca.VARIABLE
WHERE uca.OFFENSE_CATEGORY != 'All categories'
GROUP BY uct.CITY, YEAR(uct.DATE), MONTH(uct.DATE), uct.GEO_ID, uca.OFFENSE_CATEGORY
ORDER BY uct.CITY, YEAR(uct.DATE), MONTH(uct.DATE), uct.GEO_ID, uca.OFFENSE_CATEGORY;

/* 3. Urban Total Cases Counts By Reporting Level By Each City By Year and Month */
CREATE VIEW IF NOT EXISTS URBAN_City_Total_Category_Count_By_Reporting_By_Year_And_Month
AS 
SELECT CITY, YEAR(DATE) AS YEAR, MONTH(DATE) AS MONTH, REPORTING_LEVEL, OFFENSE_CATEGORY, COUNT(*) AS CASE_COUNT
FROM CRIME_STATISTICS.CYBERSYN.URBAN_CRIME_INCIDENT_LOG
GROUP BY CITY, YEAR(DATE), MONTH(DATE), REPORTING_LEVEL, OFFENSE_CATEGORY
ORDER BY CITY, YEAR(DATE), MONTH(DATE), REPORTING_LEVEL, OFFENSE_CATEGORY;

/* 4. Urban Level Cases Counts By Each City Region By Reporting Level By Year and Month */
CREATE VIEW IF NOT EXISTS URBAN_City_Region_Category_Count_By_Reporting_By_Year_And_Month
AS 
SELECT CITY, YEAR(DATE) AS YEAR, MONTH(DATE) AS MONTH, SUBSTRING(GEO_ID,5,9) AS ZIP_CODE, REPORTING_LEVEL, OFFENSE_CATEGORY, COUNT(*) AS CASE_COUNT
FROM CRIME_STATISTICS.CYBERSYN.URBAN_CRIME_INCIDENT_LOG
GROUP BY CITY, YEAR(DATE), MONTH(DATE), SUBSTRING(GEO_ID,5,9), REPORTING_LEVEL, OFFENSE_CATEGORY
ORDER BY CITY, YEAR(DATE), MONTH(DATE), SUBSTRING(GEO_ID,5,9), REPORTING_LEVEL, OFFENSE_CATEGORY;
